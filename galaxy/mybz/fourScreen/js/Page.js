$.playVideoRedefine(!0),$.playLiveOrRecRedefine(!0);var pageName="fourScreen",RECODE_DATA_KEY="fourScreen";$.recodeData(pageName,"access");var dataChannel=$.getHelper("data:channel"),CHANNEL_LIST_DS=$.UTIL.sclone(dataChannel.CHANNEL_LIST_DS),CHANNEL_LIST_NAME=$.UTIL.sclone(dataChannel.CHANNEL_LIST_NAME),channelListMap=$.UTIL.sclone(dataChannel.channelListMap),date_ds_return=[],schedule_ds=[],videoArr=[],playerList=[],listState="a",listStateArr=["a","b"],liveIndex=0,$a_list=null,$a_list_wrap=null,a_list_begin=0,a_list_index=0,a_list_size=7,a_list_fixed=3,a_list_shadow=1,$b_list=null,$b_list_wrap=null,b_list_begin=0,b_list_index=0,b_list_playing_index=0,b_list_playing_content="",b_list_size=8,b_list_fixed=4,b_list_shadow=1,$play=null,$video=null,video_index=0,listLineHeightObj={},playBillObj={},today=(new $.Date).format("yyyy-MM-dd"),playerPositionList=[{left:1443,top:110,width:372,height:206},{left:1443,top:352,width:372,height:206},{left:1443,top:594,width:372,height:206},{left:1443,top:836,width:372,height:206}];function initPage(){$a_list=$("#a_list"),$b_list=$("#b_list"),$a_list_wrap=$("#a_list_wrap"),$b_list_wrap=$("#b_list_wrap"),$play=$("#play"),$video=$("#video");var e=$("#caBg")[0].getContext("2d"),i=$("#bgImg")[0];e.drawImage(i,0,0),$.UTIL.each(playerPositionList,function(i,t){e.clearRect(i.left,i.top,i.width,i.height)}),createList(),setABWrap(),focusTo(),getLiveInfo()}function getPlayBill(e,i){(new $.Date).format("yyyy-MM-dd")!==today&&(playBillObj={});var t=i.success||function(){},n=i.error||function(){},a=e.date+"_"+e.id;playBillObj[a]&&"loading"!==playBillObj[a]?t(playBillObj[a]):"loading"!==playBillObj[a]&&(playBillObj[a]="loading",$.s.playbill.get({date:e.date,id:e.id},{success:function(e){t(e),playBillObj[a]=e},error:n}))}function savePageInfo(){$.savePageInfo(pageName,{focus:ACTIVE_OBJECT.key})}function findInfo(e,i){return window[e+"_list_"+i]}function addCurrent(e){$(e).addClass("current")}function removeAListCurrent(){$(".current","#a_list",!0).removeClass("current")}function createA_list(){for(var e="",i=0;i<CHANNEL_LIST_NAME.length;i++)e+='<div id="a_list'+i+'" class="a_list">'+CHANNEL_LIST_NAME[i]+"</div>";$a_list_wrap.html(e)}function createB_list(){for(var e="",i=0;i<CHANNEL_LIST_DS.length;i++)e+='<div id="b_list'+i+'" class="b_list"><div class="channelTitle"><div class="channelNum">'+CHANNEL_LIST_DS[i].num+'</div><div class="channelName">'+CHANNEL_LIST_DS[i].name+'</div></div><div class="liveInfo"></div></div>';$b_list_wrap.html(e)}function createList(){createA_list(),createB_list()}function setABWrap(){for(var e=0;e<listStateArr.length;e++)listLineHeightObj[listStateArr[e]]=setOnelistWrap(listStateArr[e])}function setOnelistWrap(e){var i=e+"_list",t=$("#"+i+" ."+i).clientHeight()+parseInt($("#"+i+" ."+i).css("margin-bottom")),n=t*findInfo(e,"size")+"px";return window["$"+e+"_list"].css({height:n}),t}!function(){var e=0;$.UTIL.each(CHANNEL_LIST_NAME,function(i,t){if("付费"===i)return e=t,!0});var i=channelListMap[e];delete channelListMap[e];var t=[];$.UTIL.each(channelListMap,function(e,i){t.push(e)}),channelListMap={},$.UTIL.each(t,function(e,i){channelListMap[i]=e}),CHANNEL_LIST_DS.splice(i[0],i[1]-i[0]),CHANNEL_LIST_NAME.splice(e,1)}(),$.keyTool.setDftRes({KEY_DOWN:function(){return pressDown[listState]&&pressDown[listState](),!0},KEY_UP:function(){return pressUp[listState]&&pressUp[listState](),!0},KEY_LEFT:function(){return pressLeft[listState]&&pressLeft[listState](),!0},KEY_RIGHT:function(){return pressRight[listState]&&pressRight[listState](),!0},KEY_OK:function(){return pressOk[listState]&&pressOk[listState](),!0},KEY_PAGEUP:function(){return pressPageUp[listState]&&pressPageUp[listState](),!0},KEY_PAGEDOWN:function(){return pressPageDown[listState]&&pressPageDown[listState](),!0}});var focusTimer=null;function focusTo(){var e=$("#"+listState+"_list").offsetTop(),i=$("#"+listState+"_list").offsetLeft(),t=e+listLineHeightObj[listState]*(findInfo(listState,"index")-findInfo(listState,"begin")),n=$("."+listState+"_list").offsetWidth(),a=$("."+listState+"_list").offsetHeight();if($("#focus").removeClass("b_listF play_listF video_listF"),"b"===listState?$("#focus").addClass("b_listF"):"play"===listState?$("#focus").addClass("play_listF"):"video"===listState&&$("#focus").addClass("video_listF"),"play"===listState)i=$("#play").offsetLeft(),t=$("#play").offsetTop(),n=$("#play").offsetWidth(),a=$("#play").offsetHeight();else if("video"===listState){var s=Math.round(parseFloat($("#video .video").css("border-width"))),o=Math.round(parseFloat($("#video .video").css("margin-bottom"))),l=$("#video").offsetTop()+s,d=$("#video .video").clientHeight()+o+2*s;t=l+video_index*d,i=$("#video").offsetLeft()+s,n=$("#video .video").clientWidth(),a=$("#video .video").clientHeight()}$("#focus").css({top:t+"px",left:i+"px",width:n+"px",height:a+"px"});var r={el:"#"+listState+"_list"+findInfo(listState,"index"),marquee:["#"+listState+"_list"+findInfo(listState,"index")+("b"===listState?" .channelName":" .name")]};"play"===listState?r={el:"#play"}:"video"===listState&&(r={el:"#video"+video_index}),$.focusTo(r)}var pressDown={a:function(){focusMoveMap.down("a",CHANNEL_LIST_NAME.length)||(moveList("a"),b_list_begin=channelListMap[a_list_index][0],moveList("b"),b_list_index=b_list_begin,focusTo())},b:function(){focusMoveMap.down("b",CHANNEL_LIST_DS.length)||(moveList("b"),b_list_index===channelListMap[a_list_index][1]&&focusMoveMap.down("a",CHANNEL_LIST_NAME.length),removeAListCurrent(),addCurrent("#a_list"+a_list_index),moveList("a"),focusTo())},video:function(){video_index!==videoArr.length-1&&(video_index++,focusTo())}},pressUp={a:function(){focusMoveMap.up("a")||(moveList("a"),b_list_begin=channelListMap[a_list_index][0],moveList("b"),b_list_index=b_list_begin,focusTo())},b:function(){focusMoveMap.up("b")||(moveList("b"),b_list_index===channelListMap[a_list_index][0]-1&&focusMoveMap.up("a",CHANNEL_LIST_NAME.length),removeAListCurrent(),addCurrent("#a_list"+a_list_index),moveList("a"),focusTo())},video:function(){0!==video_index&&(video_index--,focusTo())}},pressLeft={a:function(){},b:function(){listState="a",removeAListCurrent(),focusTo()},play:function(){listState="b",focusTo()},video:function(){listState=videoArr.length<2?"b":"play",focusTo()}},pressRight={a:function(){listState="b",addCurrent("#a_list"+a_list_index),focusTo()},b:function(){videoArr.length>1?listState="play":videoArr.length&&(listState="video",video_index>videoArr.length-1&&(video_index=videoArr.length-1)),focusTo()},play:function(){listState="video",video_index>videoArr.length-1&&(video_index=videoArr.length-1),focusTo()}},pressOk={b:function(){if($("#b_list"+findInfo("b","index")).attr("current")){for(var e=0;e<videoArr.length;e++)if(videoArr[e].index===findInfo("b","index")){removeVideo(e);break}removeBListCurrent(findInfo("b","index"))}else{if(videoArr.length>$(".video","#video",!0).length-1)return;var i=videoArr.length;videoArr.push({name:CHANNEL_LIST_DS[findInfo("b","index")].name,channelId:CHANNEL_LIST_DS[findInfo("b","index")].channelId,num:CHANNEL_LIST_DS[findInfo("b","index")].num,mediaId:CHANNEL_LIST_DS[findInfo("b","index")].mediaId,index:findInfo("b","index")}),$("#video"+i).addClass("transparent"),createPlayer(i),addCurrent("#b_list"+findInfo("b","index")),$("#b_list"+findInfo("b","index")).attr({current:"1"}),videoArr.length>1?$("#play").show():$("#play").hide()}},video:function(){removeBListCurrent(videoArr[video_index].index),removeVideo(video_index),videoArr.length?video_index>videoArr.length-1&&(video_index=videoArr.length-1):listState="b",focusTo()},play:function(){var e=[];$.UTIL.each(videoArr,function(i){e.push(i.channelId)}),$.gotoDetail($.search.append($.urls.playFourScreen,{channelId:e.join(",")}),!0)}},pressPageUp={a:function(){focusMoveMap.pageUp("a")||(moveList("a"),b_list_begin=channelListMap[a_list_index][0],moveList("b"),b_list_index=b_list_begin,focusTo())},b:function(){focusMoveMap.pageUp("b")||(moveList("b"),findAIndex(),a_list_begin=Math.max(findInfo("a","index")-findInfo("a","fixed"),0),removeAListCurrent(),addCurrent("#a_list"+a_list_index),moveList("a"),focusTo())}},pressPageDown={a:function(){focusMoveMap.pageDown("a",CHANNEL_LIST_NAME.length)||(moveList("a"),b_list_begin=channelListMap[a_list_index][0],moveList("b"),b_list_index=b_list_begin,focusTo())},b:function(){focusMoveMap.pageDown("b",CHANNEL_LIST_DS.length)||(moveList("b"),findAIndex(),a_list_begin=Math.max(findInfo("a","index")-findInfo("a","fixed"),0),removeAListCurrent(),addCurrent("#a_list"+a_list_index),moveList("a"),focusTo())}};function createPlayer(e){var i=new MediaPlayer("MOSAIC");i.setNativeUIFlag(0),i.set("HaveorNoVoice",1),i.setVideoDisplayMode(0),i.setVideoDisplayArea(playerPositionList[e].left,playerPositionList[e].top,playerPositionList[e].width,playerPositionList[e].height),i.refreshVideoDisplay(),i.setMuteFlag(1),playerList.push(i);var t=videoArr[e];if(t){var n={mediaCode:t.mediaId+"",mediaURL:t.num,mediaType:1,streamType:2};i.setSingleMedia(JSON.stringify(n)),i.playFromStart()}}function closePlayers(e){playerList[e].releaseMediaPlayer(playerList[e].getNativePlayerInstanceID()),playerList.splice(e,1);for(var i=e;i<playerList.length;i++)playerList[i].setVideoDisplayArea(playerPositionList[i].left,playerPositionList[i].top,playerPositionList[i].width,playerPositionList[i].height),playerList[i].refreshVideoDisplay()}function removeVideo(e){videoArr.splice(e,1),$("#video"+videoArr.length).removeClass("transparent"),videoArr.length<2&&$("#play").hide(),closePlayers(e)}function removeBListCurrent(e){$("#b_list"+e).attr({current:null}).removeClass("current")}var focusMoveMap={up:function(e){if(0===findInfo(e,"index"))return!0;(findInfo(e,"index")===findInfo(e,"begin")+findInfo(e,"fixed")&&findInfo(e,"begin")>0||findInfo(e,"index")===findInfo(e,"begin"))&&window[e+"_list_begin"]--,window[e+"_list_index"]--},down:function(e,i){if(findInfo(e,"index")===i-1)return!0;findInfo(e,"index")===findInfo(e,"begin")+findInfo(e,"fixed")&&window[e+"_list_begin"]++,window[e+"_list_index"]++},pageUp:function(e){if(0===findInfo(e,"begin"))return!0;var i=findInfo(e,"begin");window[e+"_list_begin"]-=findInfo(e,"size")-findInfo(e,"shadow"),findInfo(e,"begin")<0&&(window[e+"_list_begin"]=0);var t=i-findInfo(e,"begin");window[e+"_list_index"]-=t},pageDown:function(e,i){if(findInfo(e,"begin")===i-findInfo(e,"fixed")-1)return!0;var t=findInfo(e,"begin");window[e+"_list_begin"]+=findInfo(e,"size")-findInfo(e,"shadow"),findInfo(e,"begin")>i-findInfo(e,"fixed")-1&&(window[e+"_list_begin"]=i-findInfo(e,"fixed")-1);var n=findInfo(e,"begin")-t;window[e+"_list_index"]+=n}},getBillTimer=null;function moveList(e){window["$"+e+"_list_wrap"].css({"-webkit-transform":"translateY("+-findInfo(e,"begin")*listLineHeightObj[e]+"px)"}),"b"===e&&(clearTimeout(getBillTimer),getBillTimer=setTimeout(function(){getLiveInfo()},500))}function getLiveInfo(){var e=findInfo("b","begin"),i=Math.min(e+findInfo("b","size"),CHANNEL_LIST_DS.length),t=e;function n(){var e=CHANNEL_LIST_DS[t].channelId;getPlayBill({date:(new $.Date).format("yyyy-MM-dd"),id:e},{success:function(e){$.UTIL.each(e.programs,function(e,i){var n=e.starttime,a=e.endtime,s=(new $.Date).format("yyyy-MM-dd hh:mm:ss");s>=n&&s<a&&$("#b_list"+t+" .liveInfo").html(e.text)}),a()},error:function(){a()}})}function a(){if(++t>i-1)return!0;n()}n()}function findAIndex(){for(var e=0;e<CHANNEL_LIST_NAME.length;e++)if(findInfo("b","index")>=channelListMap[e][0]&&findInfo("b","index")<channelListMap[e][1]){a_list_index=e;break}}